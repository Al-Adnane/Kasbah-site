<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kasbah ‚Äì Live Demo</title>
  <meta name="description" content="Kasbah live demo: request a decision, consume a ticket, replay protection." />
  <link rel="icon" href="/icons/icon.svg" type="image/svg+xml">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #fffcf8;
      color: #1e1e1e;
      line-height: 1.6;
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 40px 24px; }
    .top {
      display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;
      margin-bottom: 18px;
    }
    .title { font-weight: 800; font-size: 22px; display: flex; align-items: center; gap: 10px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #1e1e1e;
      color: white;
      font-weight: 700;
      padding: 12px 18px;
      border-radius: 999px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: 0.15s;
      white-space: nowrap;
    }
    .btn:hover { background: #3a3a3a; transform: scale(0.98); }
    .btn-outline {
      background: transparent;
      border: 1.5px solid #1e1e1e;
      color: #1e1e1e;
    }
    .card {
      background: #ffffff;
      border: 1px solid #ece7e2;
      border-radius: 20px;
      padding: 18px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.02);
    }
    .grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 18px;
      margin-top: 16px;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
    label { font-size: 13px; color: #5c524a; font-weight: 700; display: block; margin: 10px 0 6px; }
    input, textarea, select {
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid #d9d0c7;
      font-size: 14px;
      background: #ffffff;
      outline: none;
    }
    textarea { min-height: 140px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    pre {
      margin: 0;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #e8e0d8;
      background: #fcf9f6;
      overflow: auto;
      font-size: 12px;
      line-height: 1.5;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }
    .hint { margin-top: 10px; color: #5c524a; font-size: 13px; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      background:#ebdfd7; color:#3a2e26;
      padding:6px 12px; border-radius:999px; font-size:12px; font-weight:700;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">üè∞ Kasbah Live Demo <span class="pill">single-use tickets</span></div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn btn-outline" href="/">‚Üê Back</a>
        <button id="btn-run" class="btn">Run Decide ‚Üí Consume</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>API Base URL</label>
          <input id="base" type="text" value="http://localhost:5000" />
        </div>
        <div>
          <label>Preset</label>
          <select id="preset">
            <option value="email" selected>Email draft (medium risk)</option>
            <option value="db">DB query (low risk)</option>
            <option value="fs">File read (medium risk)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Agent ID</label>
          <input id="agent" type="text" value="demo-user" />
        </div>
        <div>
          <label>Tool name</label>
          <input id="tool" type="text" value="email.send_draft" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Signals (JSON)</label>
          <textarea id="signals">{ "consistency": 0.95, "accuracy": 0.95 }</textarea>
        </div>
        <div>
          <label>Args (JSON)</label>
          <textarea id="args">{ "to": "client@example.com", "subject": "Draft", "body": "Hello ‚Äî here is the draft‚Ä¶" }</textarea>
        </div>
      </div>

      <div class="hint">
        If your API is running locally, keep the default Base URL.
        If it's remote, paste it here.
        If requests fail, your API must allow CORS from this domain.
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:10px;">
          <div style="font-weight:800;">1) DECIDE (POST /api/decide)</div>
          <button id="btn-decide" class="btn btn-outline">Run Decide</button>
        </div>
        <pre id="out-decide">Waiting‚Ä¶</pre>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:10px;">
          <div style="font-weight:800;">2) CONSUME (POST /api/consume)</div>
          <button id="btn-consume" class="btn btn-outline">Run Consume</button>
        </div>
        <pre id="out-consume">Waiting‚Ä¶</pre>
        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button id="btn-replay" class="btn btn-outline">Replay same ticket (should fail)</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div style="font-weight:800; margin-bottom:10px;">Current ticket</div>
      <pre id="ticket">None yet.</pre>
    </div>
  </div>

  <script>
    function byId(id){ return document.getElementById(id); }
    function safeJsonParse(s){
      try { return JSON.parse(s); } catch(e){ return null; }
    }
    function pretty(x){
      try { return JSON.stringify(x, null, 2); } catch(e){ return String(x); }
    }
    async function postJson(url, body){
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const text = await r.text();
      let data = null;
      try { data = JSON.parse(text); } catch(e){ data = { raw: text }; }
      if (!r.ok) {
        const err = new Error("HTTP " + r.status);
        err.data = data;
        throw err;
      }
      return data;
    }

    const base = byId("base");
    const preset = byId("preset");
    const agent = byId("agent");
    const tool = byId("tool");
    const signals = byId("signals");
    const args = byId("args");

    const outDecide = byId("out-decide");
    const outConsume = byId("out-consume");
    const ticketPre = byId("ticket");

    let lastTicket = null;
    let lastTool = null;

    function applyPreset(){
      const p = preset.value;
      if (p === "email") {
        tool.value = "email.send_draft";
        args.value = pretty({ to: "client@example.com", subject: "Draft", body: "Hello ‚Äî here is the draft‚Ä¶" });
        signals.value = pretty({ consistency: 0.95, accuracy: 0.95 });
      } else if (p === "db") {
        tool.value = "db.query";
        args.value = pretty({ query: "SELECT 1" });
        signals.value = pretty({ consistency: 0.99, accuracy: 0.99 });
      } else {
        tool.value = "fs.read";
        args.value = pretty({ path: "/docs/README.md" });
        signals.value = pretty({ consistency: 0.93, accuracy: 0.95 });
      }
    }
    preset.addEventListener("change", applyPreset);

    async function runDecide(){
      outDecide.textContent = "Running‚Ä¶";
      const s = safeJsonParse(signals.value);
      const a = safeJsonParse(args.value);
      if (s === null) { outDecide.textContent = "Signals JSON is invalid."; return null; }
      if (a === null) { outDecide.textContent = "Args JSON is invalid."; return null; }

      const payload = { tool: tool.value, agent_id: agent.value, signals: s, args: a };
      try {
        const data = await postJson(base.value.replace(/\/$/, "") + "/api/decide", payload);
        outDecide.textContent = pretty(data);

        // support multiple possible response shapes
        lastTicket = data.ticket || (data.result && data.result.ticket) || data.ticket_str || null;
        lastTool = tool.value;

        ticketPre.textContent = lastTicket ? String(lastTicket) : "No ticket returned (decision may be deny).";
        return data;
      } catch (e) {
        outDecide.textContent = pretty({ error: e.message, data: e.data || null });
        ticketPre.textContent = "None.";
        lastTicket = null;
        return null;
      }
    }

    async function runConsume(ticketOverride){
      outConsume.textContent = "Running‚Ä¶";
      const t = ticketOverride || lastTicket;
      if (!t) { outConsume.textContent = "No ticket to consume yet. Run Decide first."; return null; }

      const payload = { ticket: t, tool: lastTool || tool.value };
      try {
        const data = await postJson(base.value.replace(/\/$/, "") + "/api/consume", payload);
        outConsume.textContent = pretty(data);
        return data;
      } catch (e) {
        outConsume.textContent = pretty({ error: e.message, data: e.data || null });
        return null;
      }
    }

    byId("btn-decide").addEventListener("click", runDecide);
    byId("btn-consume").addEventListener("click", function(){ runConsume(); });
    byId("btn-replay").addEventListener("click", function(){ runConsume(lastTicket); });

    byId("btn-run").addEventListener("click", async function(){
      const d = await runDecide();
      if (!d) return;
      await runConsume();
    });

    applyPreset();
  </script>
</body>
</html>
