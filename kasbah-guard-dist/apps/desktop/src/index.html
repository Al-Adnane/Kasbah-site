<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kasbah Guard</title>
  <style>
    :root{
      --bg:#fffcf8; --ink:#1e1e1e; --muted:#6b625a; --card:#ffffff; --b:#e7ded6;
      --ok:#1f7a4a; --bad:#9d174d; --soft:#fcf9f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--ink)}
    .app{height:100%; display:flex; flex-direction:column}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:12px 16px; border-bottom:1px solid var(--b);
      background:rgba(255,252,248,.92); backdrop-filter:blur(8px);
      position:sticky; top:0; z-index:10;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logoBox{width:30px;height:30px;border-radius:10px;background:var(--ink);display:grid;place-items:center}
    .logoMark{width:16px;height:16px;border-radius:5px;background:var(--bg);position:relative}
    .logoMark:after{content:"";position:absolute;left:50%;top:20%;width:3px;height:60%;transform:translateX(-50%);background:var(--ink);border-radius:99px}
    .brandName{font-weight:1000; font-size:15px; letter-spacing:-.02em}
    .pill{font-size:11px; font-weight:900; padding:5px 9px; border-radius:999px; background:#ebdfd7; color:#3a2e26}
    .btn{
      border:0; cursor:pointer; border-radius:999px; padding:9px 12px; font-weight:900; font-size:12px;
      background:var(--ink); color:var(--bg); white-space:nowrap;
    }
    .btn2{background:transparent; color:var(--ink); border:1.5px solid var(--ink)}
    .main{flex:1; display:grid; grid-template-columns:320px 1fr; gap:0; overflow:hidden}
    .sidebar{
      border-right:1px solid var(--b); padding:14px;
      overflow-y:auto; display:flex; flex-direction:column; gap:14px;
    }
    .card{background:var(--card); border:1px solid var(--b); border-radius:14px; padding:12px}
    .h{font-weight:1000; font-size:13px; margin:0 0 8px}
    .k{font-size:11px; color:var(--muted); font-weight:800; line-height:1.5}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .statusDot{width:10px; height:10px; border-radius:50%}
    .ok{background:var(--ok)} .bad{background:var(--bad)}
    .log{
      flex:1; min-height:200px; overflow:auto;
      background:var(--soft); border:1px solid var(--b); border-radius:12px; padding:10px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:11px; white-space:pre-wrap; line-height:1.6; color:var(--ink);
    }
    .content{display:flex; flex-direction:column; overflow:hidden}
    .tabBar{
      display:flex; gap:0; border-bottom:1px solid var(--b); background:var(--soft);
      padding:0 12px;
    }
    .tab{
      padding:10px 16px; font-size:12px; font-weight:800; cursor:pointer;
      border-bottom:2px solid transparent; color:var(--muted);
    }
    .tab.active{color:var(--ink); border-bottom-color:var(--ink)}
    .tabContent{flex:1; overflow:hidden; position:relative}
    .tabPanel{position:absolute; inset:0; display:none}
    .tabPanel.active{display:flex; flex-direction:column}
    iframe{border:0; width:100%; flex:1}
    .welcome{padding:40px; text-align:center; flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center}
    .welcome h2{font-size:28px; margin:0 0 10px}
    .welcome p{color:var(--muted); max-width:500px; line-height:1.6}
    @media (max-width:800px){.main{grid-template-columns:1fr} .sidebar{max-height:300px}}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logoBox"><div class="logoMark"></div></div>
        <span class="brandName">Kasbah Guard</span>
        <span class="pill">Local Authority</span>
      </div>
      <div class="row">
        <div class="row" style="gap:6px">
          <div class="statusDot bad" id="svcDot"></div>
          <div class="k" id="svcTxt">Checking...</div>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="sidebar">
        <div class="card">
          <div class="h">Guard Service</div>
          <div class="row" style="margin-bottom:8px">
            <div class="statusDot bad" id="svcDot2"></div>
            <div class="k" id="svcTxt2">Checking...</div>
          </div>
          <div class="k">The local guard runs on 127.0.0.1:8788. The browser extension calls this service before allowing AI actions.</div>
        </div>

        <div class="card">
          <div class="h">Quick Test</div>
          <div class="k" style="margin-bottom:8px">With the extension installed, go to ChatGPT or Claude, type a message, and click Send. Kasbah will intercept it.</div>
          <div class="row">
            <button class="btn" onclick="switchTab('chatgpt')">ChatGPT</button>
            <button class="btn btn2" onclick="switchTab('claude')">Claude</button>
          </div>
        </div>

        <div class="card" style="flex:1; display:flex; flex-direction:column">
          <div class="h">Audit Log</div>
          <div class="log" id="log">Loading...</div>
        </div>
      </div>

      <div class="content">
        <div class="tabBar">
          <div class="tab active" data-tab="welcome" onclick="switchTab('welcome')">Home</div>
          <div class="tab" data-tab="chatgpt" onclick="switchTab('chatgpt')">ChatGPT</div>
          <div class="tab" data-tab="claude" onclick="switchTab('claude')">Claude</div>
          <div class="tab" data-tab="demo" onclick="switchTab('demo')">Dev Demo</div>
        </div>
        <div class="tabContent">
          <div class="tabPanel active" data-panel="welcome">
            <div class="welcome">
              <div class="logoBox" style="width:60px;height:60px;border-radius:16px;margin-bottom:16px">
                <div class="logoMark" style="width:32px;height:32px;border-radius:10px"></div>
              </div>
              <h2>Kasbah Guard</h2>
              <p>Permission before AI actions. Your local guard service is running. Install the browser extension, then open ChatGPT or Claude to test interception.</p>
              <div class="row" style="margin-top:20px; justify-content:center">
                <button class="btn" onclick="switchTab('chatgpt')">Open ChatGPT</button>
                <button class="btn btn2" onclick="switchTab('claude')">Open Claude</button>
              </div>
            </div>
          </div>
          <div class="tabPanel" data-panel="chatgpt">
            <iframe src="https://chatgpt.com" id="frameChatgpt"></iframe>
          </div>
          <div class="tabPanel" data-panel="claude">
            <iframe src="https://claude.ai" id="frameClaude"></iframe>
          </div>
          <div class="tabPanel" data-panel="demo">
            <iframe src="https://kasbah-site.pages.dev/dev.html" id="frameDemo"></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const GUARD = "http://127.0.0.1:8788";
  const svcDot = document.getElementById('svcDot');
  const svcTxt = document.getElementById('svcTxt');
  const svcDot2 = document.getElementById('svcDot2');
  const svcTxt2 = document.getElementById('svcTxt2');
  const logEl = document.getElementById('log');

  function setSvc(ok) {
    const cls = ok ? 'statusDot ok' : 'statusDot bad';
    const txt = ok ? 'ON (127.0.0.1:8788)' : 'OFF';
    svcDot.className = cls;
    svcTxt.textContent = txt;
    svcDot2.className = cls;
    svcTxt2.textContent = ok ? 'Guard is running' : 'Guard is not running';
  }

  async function refreshStatus() {
    try {
      const r = await fetch(GUARD + "/status", { cache: "no-store" });
      setSvc(r.ok);
    } catch(e) {
      setSvc(false);
    }
  }

  function fmtEvent(e) {
    const d = new Date(e.ts_ms);
    const time = d.toLocaleTimeString();
    const kind = e.kind || '?';
    let detail = '';
    if (e.data) {
      if (e.data.decision) detail += ' ' + e.data.decision;
      if (e.data.reason) detail += ' (' + e.data.reason + ')';
      if (e.data.ticket) detail += ' ticket:' + e.data.ticket.slice(0, 8) + '...';
      if (e.data.message) detail += ' ' + e.data.message;
    }
    return '[' + time + '] ' + kind + detail;
  }

  async function refreshEvents() {
    try {
      const r = await fetch(GUARD + "/events", { cache: "no-store" });
      if (!r.ok) throw new Error("events");
      const v = await r.json();
      if (v.length === 0) {
        logEl.textContent = 'No events yet.\n\nWaiting for extension activity...';
      } else {
        logEl.textContent = v.map(fmtEvent).join('\n');
      }
    } catch(e) {
      logEl.textContent = 'Guard service not reachable.\n\nStart the Kasbah Guard app to see audit events.';
    }
  }

  async function refreshAll() {
    await refreshStatus();
    await refreshEvents();
  }

  refreshAll();
  setInterval(refreshAll, 2000);

  function switchTab(name) {
    document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.tabPanel').forEach(function(p) { p.classList.remove('active'); });
    var tab = document.querySelector('.tab[data-tab="' + name + '"]');
    var panel = document.querySelector('.tabPanel[data-panel="' + name + '"]');
    if (tab) tab.classList.add('active');
    if (panel) panel.classList.add('active');
  }
</script>
</body>
</html>
