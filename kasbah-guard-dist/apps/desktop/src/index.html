<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kasbah Guard</title>
  <style>
    :root{
      --bg:#fffcf8;--ink:#1e1e1e;--muted:#6b625a;--card:#ffffff;--b:#e7ded6;
      --ok:#1f7a4a;--bad:#9d174d;--soft:#fcf9f6;--accent:#c96b20;--r:16px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;background:var(--bg);color:var(--ink);overflow:hidden}

    /* ─── Layout ─── */
    .app{height:100%;display:flex;flex-direction:column}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 16px;border-bottom:1px solid var(--b);
      background:rgba(255,252,248,.92);backdrop-filter:blur(12px);
      -webkit-app-region:drag;
    }
    .topbar *{-webkit-app-region:no-drag}
    .brand{display:flex;align-items:center;gap:10px;-webkit-app-region:drag}
    .logo{width:28px;height:28px;border-radius:9px;background:var(--ink);display:grid;place-items:center}
    .logo-inner{width:14px;height:14px;border-radius:4px;background:var(--bg);position:relative}
    .logo-inner:after{content:"";position:absolute;left:50%;top:20%;width:2.5px;height:60%;transform:translateX(-50%);background:var(--ink);border-radius:99px}
    .brand-name{font-weight:900;font-size:14px;letter-spacing:-.02em}
    .status-chip{
      display:flex;align-items:center;gap:6px;
      font-size:11px;font-weight:800;
      padding:5px 10px;border-radius:999px;
      background:var(--soft);border:1px solid var(--b);
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot-ok{background:var(--ok)}.dot-off{background:var(--bad)}

    .body{flex:1;display:flex;overflow:hidden}

    /* ─── Sidebar ─── */
    .sidebar{
      width:280px;min-width:280px;border-right:1px solid var(--b);
      display:flex;flex-direction:column;overflow-y:auto;
      padding:12px;gap:10px;background:var(--soft);
    }
    .card{background:var(--card);border:1px solid var(--b);border-radius:var(--r);padding:12px}
    .card-title{font-weight:900;font-size:12px;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;color:var(--muted)}
    .card-body{font-size:12px;color:var(--muted);line-height:1.5}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      padding:9px 14px;border-radius:999px;font-weight:900;font-size:12px;
      border:0;cursor:pointer;transition:transform .05s,opacity .1s;white-space:nowrap;
    }
    .btn:active{transform:scale(.97)}
    .btn-primary{background:var(--ink);color:var(--bg)}
    .btn-ghost{background:transparent;color:var(--ink);border:1.5px solid var(--b)}
    .btn-accent{background:var(--accent);color:#fff}
    .btn-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}

    /* Audit log */
    .log-wrap{flex:1;display:flex;flex-direction:column;min-height:0}
    .log{
      flex:1;overflow-y:auto;
      background:var(--bg);border:1px solid var(--b);border-radius:12px;
      padding:8px;margin-top:6px;
      font:11px/1.6 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      color:var(--ink);white-space:pre-wrap;
    }
    .log-empty{color:var(--muted);font-style:italic;font-family:system-ui}

    /* ─── Main content ─── */
    .content{flex:1;display:flex;flex-direction:column;overflow:hidden}

    /* Onboarding / Welcome */
    .onboarding{
      flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:40px;text-align:center;gap:0;
    }
    .ob-logo{width:64px;height:64px;border-radius:18px;background:var(--ink);display:grid;place-items:center;margin-bottom:20px}
    .ob-logo .logo-inner{width:34px;height:34px;border-radius:10px}
    .ob-title{font-size:26px;font-weight:900;letter-spacing:-.02em;margin-bottom:8px}
    .ob-sub{font-size:15px;color:var(--muted);max-width:440px;line-height:1.55;margin-bottom:28px}

    /* Steps */
    .steps{display:flex;gap:12px;margin-bottom:28px;width:100%;max-width:600px}
    .step{
      flex:1;background:var(--card);border:1px solid var(--b);border-radius:var(--r);
      padding:14px;text-align:left;position:relative;
    }
    .step.done{border-color:var(--ok)}
    .step.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(201,107,32,.15)}
    .step-num{
      width:22px;height:22px;border-radius:50%;
      background:var(--b);color:var(--ink);
      font-size:11px;font-weight:900;
      display:grid;place-items:center;margin-bottom:6px;
    }
    .step.done .step-num{background:var(--ok);color:#fff}
    .step.active .step-num{background:var(--accent);color:#fff}
    .step-title{font-size:12px;font-weight:900;margin-bottom:2px}
    .step-desc{font-size:11px;color:var(--muted);line-height:1.4}
    .step-check{position:absolute;top:10px;right:10px;font-size:14px}

    /* Extension install CTA */
    .install-card{
      background:var(--card);border:1px solid var(--b);border-radius:var(--r);
      padding:20px;max-width:480px;width:100%;text-align:left;
    }
    .install-title{font-size:15px;font-weight:900;margin-bottom:6px}
    .install-desc{font-size:12px;color:var(--muted);line-height:1.5;margin-bottom:12px}
    .path-box{
      background:var(--soft);border:1px solid var(--b);border-radius:10px;
      padding:8px 10px;font:11px ui-monospace,SFMono-Regular,Menlo,monospace;
      word-break:break-all;margin-bottom:10px;
    }

    /* Dashboard view */
    .dash{flex:1;display:flex;flex-direction:column;padding:16px;gap:12px;overflow-y:auto}
    .dash-title{font-size:18px;font-weight:900}
    .metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .metric{background:var(--card);border:1px solid var(--b);border-radius:var(--r);padding:12px}
    .metric-val{font-size:22px;font-weight:900}
    .metric-label{font-size:11px;color:var(--muted);margin-top:2px}
    .protected-badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 14px;border-radius:999px;
      background:#ecfdf5;border:1px solid #bbf7d0;
      font-size:12px;font-weight:900;color:var(--ok);
    }

    .hide{display:none!important}
  </style>
</head>
<body>
<div class="app">
  <!-- Top bar -->
  <div class="topbar">
    <div class="brand">
      <div class="logo"><div class="logo-inner"></div></div>
      <span class="brand-name">Kasbah Guard</span>
    </div>
    <div class="status-chip">
      <div class="dot dot-off" id="dotTop"></div>
      <span id="statusTop">Checking...</span>
    </div>
  </div>

  <div class="body">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="card">
        <div class="card-title">Guard Service</div>
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
          <div class="dot dot-off" id="dotSide"></div>
          <span class="card-body" id="statusSide" style="font-weight:800">Checking...</span>
        </div>
        <div class="card-body">Local authority on 127.0.0.1:8788</div>
      </div>

      <div class="card" id="extCard">
        <div class="card-title">Browser Extension</div>
        <div id="extStatus" class="card-body" style="font-weight:800;margin-bottom:6px">Not installed</div>
        <button class="btn btn-accent" id="installBtn" onclick="doInstallExtension()">Install Extension</button>
      </div>

      <div class="card log-wrap">
        <div class="card-title">Audit Log</div>
        <div class="log" id="log"><span class="log-empty">Waiting for activity...</span></div>
      </div>
    </div>

    <!-- Main content -->
    <div class="content">
      <!-- Onboarding view -->
      <div class="onboarding" id="viewOnboarding">
        <div class="ob-logo"><div class="logo-inner"></div></div>
        <div class="ob-title">Welcome to Kasbah Guard</div>
        <div class="ob-sub">
          Permission before AI actions. Set up in under a minute &mdash;
          no command line, no developer tools.
        </div>

        <!-- Steps indicator -->
        <div class="steps">
          <div class="step done" id="step1">
            <div class="step-num">1</div>
            <div class="step-title">App installed</div>
            <div class="step-desc">Guard service is running</div>
            <div class="step-check">&#10003;</div>
          </div>
          <div class="step active" id="step2">
            <div class="step-num">2</div>
            <div class="step-title">Browser extension</div>
            <div class="step-desc">Protect ChatGPT &amp; Claude</div>
          </div>
          <div class="step" id="step3">
            <div class="step-num">3</div>
            <div class="step-title">You're protected</div>
            <div class="step-desc">AI asks before it acts</div>
          </div>
        </div>

        <!-- Install extension card -->
        <div class="install-card" id="installCard">
          <div class="install-title">Activate browser protection</div>
          <div class="install-desc">
            Click below to install the Kasbah extension. The app will
            prepare the files and open your browser's extension page.
            Then click <b>"Load unpacked"</b> and paste the path (already copied to clipboard).
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="doInstallExtension()" id="installBtnMain">
              Install Extension Now
            </button>
            <button class="btn btn-ghost" onclick="skipToReady()">I already have it</button>
          </div>
        </div>

        <!-- After install -->
        <div class="install-card hide" id="afterInstall">
          <div class="install-title">Almost there</div>
          <div class="install-desc">
            The extension folder path has been <b>copied to your clipboard</b>.
            In Chrome, turn on <b>Developer mode</b> (toggle top-right),
            click <b>"Load unpacked"</b>, and <b>paste</b> (Cmd+V) in the folder dialog.
          </div>
          <div class="path-box" id="extPath"></div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="openExtPage()">Open Extensions Page</button>
            <button class="btn btn-ghost" onclick="skipToReady()">Done</button>
          </div>
        </div>

        <!-- Ready state -->
        <div class="hide" id="readyState" style="text-align:center">
          <div class="protected-badge" style="margin-bottom:16px">
            <div class="dot dot-ok"></div>
            Protected
          </div>
          <div style="font-size:13px;color:var(--muted);max-width:400px;margin:0 auto">
            Kasbah Guard is active. Open ChatGPT or Claude, type a message,
            and click Send &mdash; you'll see the permission modal.
          </div>
          <div class="btn-row" style="justify-content:center;margin-top:14px">
            <button class="btn btn-primary" onclick="switchView('dash')">Go to Dashboard</button>
          </div>
        </div>
      </div>

      <!-- Dashboard view -->
      <div class="dash hide" id="viewDash">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="dash-title">Dashboard</div>
          <div class="protected-badge" id="dashBadge">
            <div class="dot dot-ok"></div>
            Protected
          </div>
        </div>

        <div class="metrics">
          <div class="metric">
            <div class="metric-val" id="mTotal">0</div>
            <div class="metric-label">Total decisions</div>
          </div>
          <div class="metric">
            <div class="metric-val" id="mAllow" style="color:var(--ok)">0</div>
            <div class="metric-label">Allowed</div>
          </div>
          <div class="metric">
            <div class="metric-val" id="mDeny" style="color:var(--bad)">0</div>
            <div class="metric-label">Denied</div>
          </div>
          <div class="metric">
            <div class="metric-val" id="mReplay" style="color:var(--accent)">0</div>
            <div class="metric-label">Replay blocked</div>
          </div>
        </div>

        <div class="card" style="flex:1;display:flex;flex-direction:column;min-height:0">
          <div class="card-title">Recent Activity</div>
          <div class="log" id="dashLog" style="flex:1"><span class="log-empty">No events yet</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  var GUARD = "http://127.0.0.1:8788";
  var extensionInstalled = false;

  // --- Status polling ---
  function setStatus(ok) {
    var cls = ok ? "dot dot-ok" : "dot dot-off";
    var txt = ok ? "Guard ON" : "Guard OFF";
    document.getElementById("dotTop").className = cls;
    document.getElementById("statusTop").textContent = txt;
    document.getElementById("dotSide").className = cls;
    document.getElementById("statusSide").textContent = ok ? "Running" : "Offline";
  }

  function poll() {
    fetch(GUARD + "/status", { cache: "no-store" })
      .then(function(r) { setStatus(r.ok); })
      .catch(function() { setStatus(false); });
  }
  poll(); setInterval(poll, 3000);

  // --- Audit log ---
  function fmtEvent(e) {
    var d = new Date(e.ts_ms);
    var t = d.toLocaleTimeString();
    var k = e.kind || "?";
    var detail = "";
    if (e.data) {
      if (e.data.decision) detail += " " + e.data.decision;
      if (e.data.reason) detail += " (" + e.data.reason + ")";
      if (e.data.ticket) detail += " " + e.data.ticket.slice(0, 8) + "...";
      if (e.data.message) detail += " " + e.data.message;
    }
    return t + "  " + k + detail;
  }

  function refreshLog() {
    fetch(GUARD + "/events", { cache: "no-store" })
      .then(function(r) { return r.json(); })
      .then(function(v) {
        var logEl = document.getElementById("log");
        var dashLog = document.getElementById("dashLog");
        if (v.length === 0) {
          logEl.innerHTML = '<span class="log-empty">Waiting for activity...</span>';
          dashLog.innerHTML = '<span class="log-empty">No events yet</span>';
        } else {
          var lines = v.map(fmtEvent).join("\n");
          logEl.textContent = lines;
          dashLog.textContent = lines;

          // Count metrics
          var total = 0, allow = 0, deny = 0, replay = 0;
          v.forEach(function(e) {
            if (e.kind === "CONSUME") {
              total++;
              if (e.data && e.data.decision === "ALLOW") allow++;
              if (e.data && e.data.decision === "DENY") deny++;
              if (e.data && e.data.reason === "replay blocked") replay++;
            }
          });
          document.getElementById("mTotal").textContent = total;
          document.getElementById("mAllow").textContent = allow;
          document.getElementById("mDeny").textContent = deny;
          document.getElementById("mReplay").textContent = replay;
        }
      })
      .catch(function() {});
  }
  refreshLog(); setInterval(refreshLog, 2000);

  // --- Extension install ---
  function doInstallExtension() {
    if (window.__TAURI__) {
      window.__TAURI__.invoke("install_extension")
        .then(function(path) {
          document.getElementById("extPath").textContent = path;
          document.getElementById("installCard").classList.add("hide");
          document.getElementById("afterInstall").classList.remove("hide");
          document.getElementById("step2").classList.remove("active");
          document.getElementById("step2").classList.add("done");
          document.getElementById("step2").querySelector(".step-check") ||
            (document.getElementById("step2").innerHTML += '<div class="step-check">&#10003;</div>');
          document.getElementById("extStatus").textContent = "Installed";
          document.getElementById("installBtn").textContent = "Reinstall";
          extensionInstalled = true;
        })
        .catch(function(err) {
          // Fallback: open website download
          window.open("https://kasbah-site.pages.dev/downloads/kasbah-extension-dev.zip");
          document.getElementById("installCard").querySelector(".install-desc").textContent =
            "Extension downloaded. Unzip it, then go to chrome://extensions, enable Developer mode, and click Load unpacked.";
        });
    } else {
      // Not in Tauri (dev mode or web)
      window.open("https://kasbah-site.pages.dev/downloads/kasbah-extension-dev.zip");
    }
  }

  function openExtPage() {
    if (window.__TAURI__) {
      window.__TAURI__.invoke("open_chrome_extensions").catch(function() {
        window.open("chrome://extensions");
      });
    }
  }

  function skipToReady() {
    document.getElementById("installCard").classList.add("hide");
    document.getElementById("afterInstall").classList.add("hide");
    document.getElementById("readyState").classList.remove("hide");
    document.getElementById("step2").classList.remove("active");
    document.getElementById("step2").classList.add("done");
    document.getElementById("step3").classList.add("done");
    document.getElementById("extStatus").textContent = "Installed";
    extensionInstalled = true;
  }

  function switchView(name) {
    document.getElementById("viewOnboarding").classList.toggle("hide", name !== "onboard");
    document.getElementById("viewDash").classList.toggle("hide", name !== "dash");
  }
</script>
</body>
</html>
